<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Single Notion</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1 class="title">Single Notion</h1>
        <p class="subtitle">노션 페이지를 끊김없는 PDF로 변환합니다.</p>
        
        <div class="card">
            <form id="convertForm">
                <div class="form-group">
                    <label for="url">Target URL:</label>
                    <input type="text" id="url" name="url" placeholder="https://notion.site/..." required>
                </div>
                <div class="form-group">
                    <label for="width">Width (px):</label>
                    <input type="text" id="width" name="width" value="1080px">
                </div>
                <div class="form-group checkbox-group">
                    <label class="option"><input type="checkbox" name="includeTitle" value="true"> <span>Include Title</span></label>
                    <label class="option"><input type="checkbox" name="includeBanner" value="true"> <span>Include Banner</span></label>
                    <label class="option"><input type="checkbox" name="includeTags" value="true"> <span>Include Tags</span></label>
                </div>
                <button type="submit" id="submitBtn" class="submit-btn">Convert to PDF</button>
            </form>
        </div>

        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="spinner"></div>
            <p class="loading-text">PDF 변환 중입니다.<br>최대 2분 정도 소요될 수 있습니다...</p>
        </div>
    </div>

    <script>
        document.getElementById('convertForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.querySelector('.loading-text');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Converting...';
            loadingOverlay.style.display = 'flex';
            loadingText.innerHTML = 'PDF 변환 대기열에 등록 중입니다...';

            // 기존 코드 부분
            const formData = new FormData(this);

            // 1. URL 전처리 로직 추가
            let rawUrl = formData.get('url').trim();
            try {
                const urlObj = new URL(rawUrl);
                // 쿼리 스트링(?, source=... 등) 제거
                const cleanUrl = `${urlObj.origin}${urlObj.pathname}`;
                rawUrl = cleanUrl;
            } catch (e) {
                // URL 형식이 아예 아닐 경우 처리
                alert('올바른 URL 형식이 아닙니다.');
                resetUI();
                return;
            }

            const data = {
                url: rawUrl, // 깨끗해진 URL 전달
                width: formData.get('width') || '1080px',
                includeTitle: formData.get('includeTitle') === 'true',
                includeBanner: formData.get('includeBanner') === 'true',
                includeTags: formData.get('includeTags') === 'true'
            };

            try {
                // 1. 변환 요청 (Job 생성)
                const response = await fetch('/convert-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const resData = await response.json();
                if (!response.ok) throw new Error(resData.error || '요청 실패');

                const jobId = resData.jobId;
                loadingText.innerHTML = '변환 진행 중입니다.<br>최대 2분 정도 소요될 수 있습니다...';

                // 2. SSE를 이용한 상태 수신 (Polling 대체)
                const eventSource = new EventSource(`/job-events/${jobId}`);

                eventSource.onmessage = function(event) {
                    const statusData = JSON.parse(event.data);

                    if (statusData.status === 'completed') {
                        eventSource.close(); // 작업 완료 시 연결 종료
                        
                        // 다운로드 트리거
                        const a = document.createElement('a');
                        a.href = statusData.result.downloadUrl;
                        a.download = statusData.result.fileName;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();

                        resetUI();
                    } else if (statusData.status === 'failed' || statusData.status === 'error') {
                        eventSource.close(); // 작업 실패 시 연결 종료
                        alert(`오류 발생: ${statusData.error || '변환 중 오류가 발생했습니다.'}`);
                        resetUI();
                    }
                };

                eventSource.onerror = function(err) {
                    eventSource.close(); // 통신 에러 발생 시 연결 종료
                    alert('서버와의 연결이 끊어졌습니다.');
                    resetUI();
                };

            } catch (error) {
                alert(`오류 발생: ${error.message}`);
                resetUI();
            }

            function resetUI() {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Convert to PDF';
                loadingOverlay.style.display = 'none';
            }
        });
    </script>
</body>
</html>